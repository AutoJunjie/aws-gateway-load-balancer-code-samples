AWSTemplateFormatVersion: '2010-09-09'

Description: >-
  This template creates centralized inspection architecture comprising of
  Transit Gateway (TGW), Gateway Load Balancer (GWLB) and Gateway Load
  Balancer Endpoint (GWLBe) across 2 Availability Zones (AZ). This is a nested
  stack implementation. This is the primary template for the nested stack.

  This primary template when deployed, creates:
    1. Appliance VPC Template - responsible for traffic inspection
    2. Spoke1 VPC Template - acting as Spoke1
    3. Spoke2 VPC Template - acting as Spoke2
    4. Transit Gateway Template - for connecting VPCs together
  
  All the templates are deployed in same account. In their current state,
  templates do not support multi account set up.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Appliance VPC Network Configuration
        Parameters:
          - ApplianceVpcCidr
          - ApplianceAz1
          - ApplianceTgwAttachSubnet1Cidr
          - ApplianceGwlbSubnet1Cidr
          - ApplianceNatgwSubnet1Cidr
          - ApplianceAz2
          - ApplianceTgwAttachSubnet2Cidr
          - ApplianceGwlbSubnet2Cidr
          - ApplianceNatgwSubnet2Cidr
      - Label:
          default: Appliance VPC Gateway Load Balancer Configuration
        Parameters:
          - ApplianceGwlbName
          - ApplianceTargetGroupName
          - ApplianceHealthPort
          - ApplianceHealthProtocol
      - Label:
          default: Spoke1 VPC Network Configuration
        Parameters:
          - Spoke1VpcCidr
          - Spoke1Az1
          - Spoke1ApplicationSubnet1Cidr
          - Spoke1TgwAttachSubnet1Cidr
          - Spoke1BastionSubnet1Cidr
          - Spoke1Az2
          - Spoke1ApplicationSubnet2Cidr
          - Spoke1TgwAttachSubnet2Cidr
          - Spoke1BastionSubnet2Cidr
      - Label:
          default: Spoke2 VPC Network Configuration
        Parameters:
          - Spoke1pcCidr
          - Spoke1Az1
          - Spoke1ApplicationSubnet1Cidr
          - Spoke1TgwAttachSubnet1Cidr
          - Spoke1BastionSubnet1Cidr
          - Spoke1Az2
          - Spoke1ApplicationSubnet2Cidr
          - Spoke1TgwAttachSubnet2Cidr
          - Spoke1BastionSubnet2Cidr
          - Spoke1CreateBastionCondition
      - Label:
          default: EC2 Instance Configuration
        Parameters:
          - InstanceType
          - InstanceAmiId          
          - InstanceDiskSize
          - InstanceKeyPairName
      - Label:
          default: Network CIDR for Access
        Parameters:
          - AccessLocation

    ParameterLabels:
    # Appliance VPC Parameter Labels:
      ApplianceVpcCidr:
        default: Appliance VPC - Network CIDR for VPC
      ApplianceAz1:
        default: Appliance VPC - AZ1
      ApplianceTgwAttachSubnet1Cidr:
        default: Appliance VPC - Network CIDR for TGW Attachment Subnet in AZ1
      ApplianceGwlbSubnet1Cidr:
        default: Appliance VPC - Network CIDR for GWLB Subnet in AZ1
      ApplianceNatgwSubnet1Cidr:
        default: Appliance VPC - Network CIDR for NAT gateway Subnet in AZ1
      ApplianceAz2:
        default: Appliance VPC - AZ2        
      ApplianceTgwAttachSubnet2Cidr:
        default: Appliance VPC - Network CIDR for TGW Attachment Subnet in AZ2
      ApplianceGwlbSubnet2Cidr:
        default: Appliance VPC - Network CIDR for GWLB Subnet in AZ2
      ApplianceNatgwSubnet2Cidr:
        default: Appliance VPC - Network CIDR for NAT gateway Subnet in AZ2
      ApplianceGwlbName:
        default: Gateway Load Balancer Name
      ApplianceTargetGroupName:
        default: Target Group Name
      ApplianceHealthPort:
        default: Health Check Port
      ApplianceHealthProtocol:
        default: Health Check Protocol
    # Spoke1 VPC Parameter Labels: 
      Spoke1VpcCidr:
        default: Spoke1 VPC - Network CIDR for VPC   
      Spoke1Az1:
        default: Spoke1 VPC - AZ1
      Spoke1ApplicationSubnet1Cidr:
        default: Spoke1 VPC - Application Subnet 1 CIDR
      Spoke1TgwAttachSubnet1Cidr:
        default: Spoke1 VPC - GW Attachment Subnet 1 CIDR
      Spoke1BastionSubnet1Cidr:
        default: Spoke1 VPC - Bastion Subnet 1 CIDR    
      Spoke1Az2:
        default: Spoke1 VPC - AZ2
      Spoke1ApplicationSubnet2Cidr:
        default: Spoke1 VPC - Application Subnet 2 CIDR
      Spoke1TgwAttachSubnet2Cidr:
        default: Spoke1 VPC - TGW Attachment Subnet 2 CIDR    
      Spoke1BastionSubnet2Cidr:
        default: Spoke1 VPC - Bastion Subnet 2 CIDR
      Spoke1CreateBastionCondition:
        default: Spoke1 VPC - Create Bastion Host Condition        
    # Spoke2 VPC Parameter Labels: 
      Spoke2VpcCidr:
        default: Spoke2 VPC - VPC CIDR
      Spoke2Az1:
        default: Spoke2 VPC - AZ1
      Spoke2ApplicationSubnet1Cidr:
        default: Spoke2 VPC - Application Subnet 1 CIDR
      Spoke2TgwAttachSubnet1Cidr:
        default: Spoke2 VPC - TGW Attachment Subnet 1 CIDR
      Spoke2BastionSubnet1Cidr:
        default: Spoke2 VPC - Bastion Subnet 1 CIDR  
      Spoke2Az2:
        default: Spoke2 VPC - AZ2
      Spoke2ApplicationSubnet2Cidr:
        default: Spoke2 VPC - Application Subnet 2 CIDR
      Spoke2TgwAttachSubnet2Cidr:
        default: Spoke2 VPC - TGW Attachment Subnet 2 CIDR  
      Spoke2BastionSubnet2Cidr:
        default: Spoke2 VPC - Bastion Subnet 2 CIDR
      Spoke2CreateBastionCondition:
        default: Spoke2 VPC - Create Bastion Host Condition
    # Instance Parameter Labels:
      InstanceType:
        default: Instance Type
      InstanceAmiId:
        default: Latest AMI ID for instance     
      InstanceDiskSize:
        default: Instance Size in GB
      InstanceKeyPairName:
        default: KeyPair required for accessing instances
    # Access Locateion Parameter Labels:
      AccessLocation:
        default: Network CIDR to access Appliance instance

Parameters:
# Appliance VPC Parameters:
  ApplianceVpcCidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.0/24
    Description: Appliance VPC - CIDR block for the VPC
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/y
  # Availability Zone 1:
  ApplianceAz1:
    Description: Appliance VPC - Availability Zone 1
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  ApplianceTgwAttachSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.0/28
    Description: Appliance VPC - TGW Attachment Subnet 1 CIDR in AZ1
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  ApplianceGwlbSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.16/28
    Description: Appliance VPC - GWLB Subnet 1 CIDR in AZ1
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  ApplianceNatgwSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.32/28
    Description: Appliance VPC - NAT GW Subnet 1 CIDR in AZ1
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  # Availability Zone 2:  
  ApplianceAz2:
    Description: ppliance VPC - Availability Zone 2
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  ApplianceTgwAttachSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.48/28
    Description: Appliance VPC - TGW Attachment Subnet 2 CIDR in AZ2
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
  ApplianceGwlbSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.64/28
    Description: Appliance VPC - GWLB Subnet 2 CIDR in AZ2
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
 Appliance NatgwSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 192.168.1.80/28
    Description: Appliance VPC - NAT GW Subnet 2 CIDR in AZ2
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
# Spoke1 VPC Parameters:
  Spoke1VpcCidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.0/24
    Description: Spoke1 VPC - CIDR block for the VPC
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/25
  # Availability Zone 1:
  Spoke1Az1:
    Description: Spoke1 VPC - Availability Zone 1
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  Spoke1BastionSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.0/28
    Description: Spoke1 VPC - Bastion Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke1ApplicationSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.16/28
    Description: Spoke1 VPC - Application Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke1TgwAttachSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.32/28
    Description: Spoke1 VPC - TGW Attachment Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke1CreateBastionCondition:
    Description: >- 
      Do you want to create bastion setup for Spoke1 VPC? If yes, template creates bastion
      host and bastion security group
    Default: "Yes"
    AllowedValues: ["Yes", "No"]
    Type: String
    ConstraintDescription: Must be a valid Yes or No option    
  # Availability Zone 2:
  Spoke1AvailabilityZone2:
    Description: Spoke1 VPC - Availability Zone 2
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  Spoke1BastionSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.48/28
    Description: Spoke1 VPC - Bastion Subnet 2 CIDR in Availability Zone 2
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28    
  Spoke1ApplicationSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.64/28
    Description: Spoke1 VPC - Application Subnet 2 CIDR in Availability Zone 2
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke1TgwAttachSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.80/28
    Description: Spoke1 VPC - TGW Attachment Subnet 2 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
# Spoke2 VPC Parameters:
  # Availability Zone 1:
  Spoke2VpcCidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.0/24
    Description: Spoke2 VPC - CIDR block for the VPC
    Type: String
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/25
  Spoke2Az1:
    Description: Spoke2 VPC - Availability Zone 1
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  Spoke2BastionSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.0/28
    Description: Spoke2 VPC - Bastion Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke2ApplicationSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.16/28
    Description: Spoke2 VPC - Application Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke2TgwAttachSubnet1Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.32/28
    Description: Spoke2 VPC - TGW Attachment Subnet 1 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke2CreateBastionCondition:
    Description: >- 
      Do you want to create bastion setup for Spoke2 VPC? If yes, template creates bastion
      host and bastion security group
    Default: "Yes"
    AllowedValues: ["Yes", "No"]
    Type: String
    ConstraintDescription: Must be a valid Yes or No option    
  # Availability Zone 2:
  Spoke2AvailabilityZone2:
    Description: Spoke2 VPC - Availability Zone 2
    Type: AWS::EC2::AvailabilityZone::Name
    ConstraintDescription: Valid Availability Zone Id
  Spoke2BastionSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.48/28
    Description: Spoke2 VPC - Bastion Subnet 2 CIDR in Availability Zone 2
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28    
  Spoke2ApplicationSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.64/28
    Description: Spoke2 VPC - Application Subnet 2 CIDR in Availability Zone 2
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
  Spoke2TgwAttachSubnet2Cidr:
    AllowedPattern: "^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\\/(1[6-9]|2[0-8]))$"
    Default: 10.0.0.80/28
    Description: Spoke2 VPC - TGW Attachment Subnet 2 CIDR in Availability Zone 1
    Type: String
    ConstraintDescription: Subnet CIDR parameter must be in the form x.x.x.x/16-28
# Instance Parameters:
  InstanceType:
    Description: Select EC2 instance type for instance. Default is set to t2.micro
    Default: t2.micro
    AllowedValues:
      - t2.micro
    Type: String
  InstanceAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'    
  InstanceDiskSize:
    Description: Instance disk size in GB. Default is set to 8GB
    Default: 8
    AllowedValues: [8]
    Type: Number
    ConstraintDescription: Should be a valid instance size in GB
  InstanceKeyPairName:
    Description: EC2 KeyPair required for accessing EC2 instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Must be the name of an existing EC2 KeyPair
# Access Location Parameters:
  AccessLocation:
    Description: >-
      Enter desired Network CIDR for access to appropriate resources. Default is set to
      access from anywhere and it is not recommended
    AllowedPattern: "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})"
    MinLength: "9"
    MaxLength: "18"
    Default: 0.0.0.0/0
    Type: String
    ConstraintDescription: Must be a valid Network CIDR of the form x.x.x.x/y

Resources:
  ApplianceVpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: 'https://s3-us-west-2.amazonaws.com/privatelink-oregon/provider/aws-vpce-service-vpc.yaml'
      Parameters:
        VpcCidr: !Ref ApplianceVpcCidr
        AvailabilityZone1: !Ref ApplianceAz1
        TgwAttachSubnet1Cidr: !Ref ApplainceTgwAttachSubnet1Cidr
        GwlbSubnet1Cidr: !Ref ApplainceGwlbSubnet1Cidr
        NatgwSubnet1Cidr: !Ref ApplianceNatgwSubnet1Cidr
        AvailabilityZone2: !Ref ApplianceAz2
        TgwAttachSubnet2Cidr: !Ref ApplianceTgwAttachSubnet2Cidr
        GwlbSubnet2Cidr: !Ref ApplianceGwlbSubnet2Cidr
        NatgwSubnet2Cidr: !Ref ApplianceNatgwSubnet2Cidr
        GwlbName: !Ref ApplianceGwlbName
        TargetGroupName: !Ref ApplianceTargetGroupName
        HealthPort: !Ref ApplianceHealthPort
        HealthProtocol: !Ref ApplianceHealthProtocol
        ApplianceInstanceType: !Ref InstanceType
        ApplianceInstanceAmiId: !Ref InstanceAmiId      
        ApplianceInstanceDiskSize: !Ref InstanceDiskSize
        KeyPairName: !Ref InstanceKeyPairName
        AccessLocation: !Ref AccessLocation
        Spoke1VpcCidr: !Ref Spoke1VpcCidr
        Spoke1VpcCidr: !Ref Spoke2VpcCidr
  
  Spoke1VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: 'https://s3-us-west-2.amazonaws.com/privatelink-oregon/provider/aws-vpce-service-vpc.yaml'
      Parameters:
        VpcCidr: !Ref Spoke1VpcCidr
        AvailabilityZone1: !Ref Spoke1Az1
        ApplicationSubnet1Cidr: !Ref Spoke1ApplicationSubnet1Cidr
        TgwAttachSubnet1Cidr: !Ref Spoke1TgwAttachSubnet1Cidr
        BastionSubnet1Cidr: !Ref Spoke1BastionSubnet1Cidr
        AvailabilityZone2: !Ref Spoke1Az2
        ApplicationSubnet2Cidr: !Ref Spoke1ApplicationSubnet2Cidr
        TgwAttachSubnet2Cidr: !Ref Spoke1TgwAttachSubnet2Cidr
        BastionSubnet2Cidr: !Ref Spoke1BastionSubnet2Cidr
        CreateBastionCondition: !Ref Spoke1CreateBastionCondition
        ApplicationInstanceType: !Ref InstanceType
        ApplicationInstanceAmiId: !Ref InstanceAmiId      
        ApplicationInstanceDiskSize: !Ref InstanceDiskSize
        KeyPairName: !Ref InstanceKeyPairName
        AccessLocation: !Ref AccessLocation
  
  Spoke2VpcStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: 'https://s3-us-west-2.amazonaws.com/privatelink-oregon/provider/aws-vpce-service-vpc.yaml'
      Parameters:
        VpcCidr: !Ref Spoke2VpcCidr
        AvailabilityZone1: !Ref Spoke2Az1
        ApplicationSubnet1Cidr: !Ref Spoke2ApplicationSubnet1Cidr
        TgwAttachSubnet1Cidr: !Ref Spoke2TgwAttachSubnet1Cidr
        BastionSubnet1Cidr: !Ref Spoke2BastionSubnet1Cidr
        AvailabilityZone2: !Ref Spoke2Az2
        ApplicationSubnet2Cidr: !Ref Spoke2ApplicationSubnet2Cidr
        TgwAttachSubnet2Cidr: !Ref Spoke2TgwAttachSubnet2Cidr
        BastionSubnet2Cidr: !Ref Spoke2BastionSubnet2Cidr
        CreateBastionCondition: !Ref Spoke2CreateBastionCondition
        ApplicationInstanceType: !Ref InstanceType
        ApplicationInstanceAmiId: !Ref InstanceAmiId      
        ApplicationInstanceDiskSize: !Ref InstanceDiskSize
        KeyPairName: !Ref InstanceKeyPairName
        AccessLocation: !Ref AccessLocation
